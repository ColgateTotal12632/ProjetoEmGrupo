@model ProjetoDaora.Models.Venda

@{
    ViewData["Title"] = "Criar Venda";
}

<div class="container mt-5">
    <div class="card shadow-lg border-0 rounded-4">
        <div class="card-header text-white" style="background-color: #f0d165;">
            <h3 class="mb-0 text-dark fw-bold">Criar Venda</h3>
        </div>

        <div class="card-body">
            <h5 class="text-muted mb-4">Preencha os dados da venda abaixo:</h5>

            <form asp-action="Create" method="post">
                <div asp-validation-summary="ModelOnly" class="text-danger mb-3"></div>

                <!-- VENDEDOR -->
                <div class="mb-3">
                    <label asp-for="VendedorId" class="form-label fw-semibold">Vendedor</label>
                    <select asp-for="VendedorId" class="form-select rounded-3 shadow-sm" asp-items="ViewBag.VendedorId">
                        <option value="">Selecione o vendedor</option>
                    </select>
                    <span asp-validation-for="VendedorId" class="text-danger"></span>
                </div>

                <!-- CAMPOS BÁSICOS -->
                <div class="row">
                    <div class="col-md-6 mb-3">
                        <label asp-for="DataVenda" class="form-label fw-semibold">Data da Venda</label>
                        <input asp-for="DataVenda" type="date" class="form-control rounded-3 shadow-sm" />
                        <span asp-validation-for="DataVenda" class="text-danger"></span>
                    </div>

                    <div class="col-md-6 mb-3">
                        <label asp-for="ValorTotal" class="form-label fw-semibold">Valor Total</label>
                        <input asp-for="ValorTotal" class="form-control rounded-3 shadow-sm" placeholder="Será calculado automaticamente" readonly />
                    </div>
                </div>

                <hr class="my-4" />

                <!-- ITENS DA VENDA -->
                <h4 class="fw-bold mb-3">Itens da Venda</h4>

                <div class="row">
                    <div class="col-md-4 mb-3">
                        <label class="form-label fw-semibold">Produto</label>
                        <select id="produtoSelect" class="form-select rounded-3 shadow-sm" asp-items="ViewBag.ProdutoId">
                            <option value="">Selecione o produto</option>
                        </select>
                    </div>

                    <div class="col-md-2 mb-3">
                        <label class="form-label fw-semibold">Qtd</label>
                        <input id="quantidade" type="number" min="1" value="1" class="form-control rounded-3 shadow-sm" />
                    </div>

                    <div class="col-md-3 mb-3">
                        <label class="form-label fw-semibold">Preço Unitário</label>
                        <input id="preco" type="number" step="0.01" class="form-control rounded-3 shadow-sm" placeholder="Auto" />
                    </div>

                    <div class="col-md-3 mb-3 d-flex align-items-end">
                        <button type="button" id="addItem" class="btn fw-bold text-dark w-100" style="background-color: #f0d165;">
                            Adicionar Item
                        </button>
                    </div>
                </div>

                <!-- TABELA DE ITENS -->
                <table class="table table-bordered mt-3" id="itensTable">
                    <thead class="table-light">
                        <tr>
                            <th>Produto</th>
                            <th>Qtd</th>
                            <th>Preço</th>
                            <th>Total</th>
                            <th></th>
                        </tr>
                    </thead>
                    <tbody></tbody>
                </table>

                <!-- BOTÕES -->
                <div class="d-flex justify-content-between align-items-center mt-4">
                    <a asp-action="Index" class="btn btn-outline-secondary px-4">
                        ← Voltar para a lista
                    </a>
                    <input type="submit" value="Criar Venda" class="btn text-dark fw-bold px-4" style="background-color: #f0d165;" />
                </div>
            </form>
        </div>
    </div>
</div>

@section Scripts {
    @await Html.PartialAsync("_ValidationScriptsPartial")

    <script>
        let itemIndex = 0;

        // Busca preço do produto automaticamente
        $("#produtoSelect").change(function () {
            let id = $(this).val();
            if (!id) return;

            $.get("/Produtos/GetPrecoProduto/" + id, function (preco) {
                $("#preco").val(preco);
            });
        });

        // ADICIONAR ITEM
        $("#addItem").click(function () {
            let produtoId = $("#produtoSelect").val();
            let produtoNome = $("#produtoSelect option:selected").text();
            let quantidade = $("#quantidade").val();
            let preco = $("#preco").val();

            if (!produtoId || quantidade <= 0 || preco <= 0) {
                alert("Preencha corretamente os campos do item!");
                return;
            }

            let total = (quantidade * preco).toFixed(2);

            let row = `
                <tr>
                    <td>${produtoNome}</td>
                    <td>${quantidade}</td>
                    <td>${preco}</td>
                    <td>${total}</td>
                    <td><button type="button" class="btn btn-danger btn-sm removeItem">X</button></td>

                    <input type="hidden" name="Itens[${itemIndex}].ProdutoId" value="${produtoId}" />
                    <input type="hidden" name="Itens[${itemIndex}].Quantidade" value="${quantidade}" />
                    <input type="hidden" name="Itens[${itemIndex}].PrecoUnitario" value="${preco}" />
                </tr>
            `;

            $("#itensTable tbody").append(row);
            itemIndex++;

            atualizarTotalVenda();
        });

        // REMOVER ITEM
        $(document).on("click", ".removeItem", function () {
            $(this).closest("tr").remove();
            atualizarTotalVenda();
        });

        function atualizarTotalVenda() {
            let total = 0;

            $("#itensTable tbody tr").each(function () {
                let valor = parseFloat($(this).find("td:nth-child(4)").text());
                total += valor;
            });

            $("input[name='ValorTotal']").val(total.toFixed(2));
        }
    </script>
}
